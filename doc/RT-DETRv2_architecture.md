# RT-DETRv2 アーキテクチャ解説

## 概要

RT-DETRv2は、2024年7月にBaiduから発表された「RT-DETRv2: Improved Baseline with Bag-of-Freebies for Real-Time Detection Transformer」論文で提案されたリアルタイム物体検出モデルです。元のRT-DETRアーキテクチャを基に、柔軟性と実用性を向上させる改良を加えています。

## 全体アーキテクチャ

RT-DETRv2は以下の3つの主要コンポーネントで構成されています：

1. **バックボーンネットワーク** - 多段階特徴抽出
2. **ハイブリッドエンコーダー** - 効率的な特徴融合
3. **トランスフォーマーデコーダー** - 直接的な物体検出

```
入力画像 → バックボーン → ハイブリッドエンコーダー → トランスフォーマーデコーダー → 検出結果
           {S3,S4,S5}    AIFI + CCFM          300クエリ
```

## 1. バックボーンネットワーク

### 構造
- **デフォルト**: ResNet50
- **サポート**: ResNet18, ResNet101などの他のResNetバリアント
- **出力**: 最後の3ステージ {S3, S4, S5} の特徴マップ

### 特徴
- マルチスケール特徴抽出により、異なる解像度でのオブジェクト検出を可能
- S3（低レベル）からS5（高レベル）まで、階層的な特徴表現を提供

## 2. ハイブリッドエンコーダー

ハイブリッドエンコーダーは、CNNとTransformerの利点を組み合わせた革新的な設計で、2つのモジュールから構成されます。

### 2.1 AIFI（Attention-based Intra-scale Feature Interaction）

#### 目的と動作
- **目的**: 高レベル特徴間の概念的関係性を捉える
- **適用範囲**: 主にS5段階（最高レベル）の特徴に対してセルフアテンションを適用
- **効率化**: 低レベル特徴（S3、S4）には適用せず、計算コストを削減

#### 技術的利点
- 高レベルセマンティック情報に富む特徴のみに焦点を当てることで、物体の局在化と認識を強化
- 冗長性と混乱を回避し、計算効率を向上

### 2.2 CCFM（CNN-based Cross-scale Feature Fusion）

#### 構造と機能
- **構成**: 複数の畳み込み層で構成されたフュージョンブロック
- **役割**: 異なるスケール間の特徴融合を実行
- **革新性**: イントラスケール相互作用とクロススケール融合を分離

#### 効率性の向上
従来のTransformerベースアーキテクチャが全スケールを同時処理するのに対し、RT-DETRは処理を分離することで計算コストを大幅に削減。

## 3. トランスフォーマーデコーダー

### 基本構造
- **オブジェクトクエリ数**: 300個
- **予測方式**: NMS（Non-Maximum Suppression）などの後処理が不要
- **一対一予測**: 各クエリが一つのオブジェクトを予測し、重複検出を回避

### クエリ選択メカニズム
- **IoU-aware クエリ選択**: エンコーダー出力から最適な特徴を選択
- **初期化**: 上位300個のエンコーダー特徴をデコーダーのオブジェクトクエリの初期値として使用
- **反復改良**: デコーダー層が予測を反復的に改良

## 4. RT-DETRv2の改良点

### 4.1 セレクティブマルチスケール特徴抽出

#### 改良内容
- **変形可能アテンションモジュール**の改良
- **異なるスケールに対して異なる数のサンプリングポイント**を設定
- デコーダーによるより柔軟で効率的な特徴抽出を実現

#### 技術的意義
従来の固定サンプリングポイントから、スケール適応型サンプリングに進化し、各スケールの特性に最適化された特徴抽出を可能にしました。

### 4.2 離散サンプリングオペレーター

#### 改良内容
- **grid_sample**から**discrete_sample**への置き換え
- **予測されたサンプリングオフセットの丸め処理**を実行
- DETRに特有の展開制約を除去

#### 実用的メリット
- 異なるプラットフォーム間での互換性を向上
- 展開時の制約を大幅に軽減

### 4.3 動的データ拡張

#### 戦略
- **初期訓練期間**: より強いデータ拡張を適用してモデルの汎化能力を向上
- **後期エポック**: 拡張強度を段階的に減少させ、ターゲットドメインへの適応を支援

#### 効果
モデルの過学習を防ぎつつ、実際の展開環境での性能を最適化。

### 4.4 スケール適応ハイパーパラメータ

#### 調整戦略
- **バックボーンの複雑さに基づく学習率の動的調整**
- **軽量バックボーン**（ResNet18など）: 学習率を増加
- **大型バックボーン**（ResNet101など）: 学習率を減少

#### 最適化効果
各バックボーンの特性に応じた最適な学習戦略により、全体的な性能向上を実現。

## 5. 性能データ

### RT-DETR（ベースライン）
- **RT-DETR-R50**: COCO で 53.1% AP、T4 GPU で 108 FPS
- **RT-DETR-L**: 53.0% AP、114 FPS
- **RT-DETR-X**: 54.8% AP、74 FPS

### RT-DETRv2（改良版）
- **RT-DETRv2-S**: 48.1% mAP（+1.6改善）
- **RT-DETRv2-M**: 49.9% mAP（+1.0改善）
- **RT-DETRv2-L**: 53.4% mAP（+0.3改善）

### 競合比較
RT-DETRシリーズは、従来のYOLOシリーズを速度と精度の両面で上回る性能を実現し、リアルタイム物体検出の新たな標準を確立しています。

## 6. 技術的革新性

### Bag-of-Freebies アプローチ
RT-DETRv2は「Bag-of-Freebies」（無料の改良集）アプローチを採用し、推論速度を犠牲にすることなく性能向上を実現しています。

### ハイブリッド設計の利点
- **CNNの効率性**: 局所的特徴抽出の効率性を活用
- **Transformerのグローバル理解**: 長距離依存関係と全体的コンテキストの理解
- **リアルタイム性能**: 両者の利点を組み合わせながら高速推論を維持

## 7. 実用的応用

### 適用分野
- リアルタイム物体検出
- 自動運転システム
- 監視システム
- モバイル・エッジデバイス

### 技術的優位性
- NMS不要による推論の高速化
- 一対一予測による重複検出の回避
- スケール適応型処理による精度向上
- プラットフォーム間の高い互換性

## まとめ

RT-DETRv2は、リアルタイム物体検出において画期的な進歩を遂げたモデルです。ハイブリッドエンコーダーによる効率的な特徴処理、改良されたデコーダー設計、そして実用性を重視した「Bag-of-Freebies」アプローチにより、速度と精度の最適なバランスを実現しています。

特に、セレクティブマルチスケール特徴抽出と離散サンプリングオペレーターの導入により、従来のDETRアーキテクチャの制約を克服し、実世界の展開において高い実用性を提供しています。